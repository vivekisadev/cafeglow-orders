<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Table <%= tableNum %> Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #ff6b00;
            --primary-dark: #e55d00;
            --bg: #121212;
            --card: #1c110a;
            --text: #e5c07b;
        }
        body { background: var(--bg); color: var(--text); }
        .card { background: var(--card); border: 1px solid #3a2b1a; border-radius: 0.5rem; }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: var(--primary-dark); }
    </style>
</head>
<body class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
        <header class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold">Table <span id="tableNum"><%= tableNum %></span> Menu</h1>
            <button id="cartBtn" class="relative btn-primary text-white px-4 py-2 rounded-lg">
                <i class="fas fa-shopping-cart mr-2"></i>Cart <span id="cartCount" class="absolute -top-2 -right-2 bg-yellow-600 text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
            </button>
        </header>

        <div id="menu" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <% items.forEach(item => { %>
            <div class="card p-4 flex justify-between items-center" data-id="<%= item._id %>">
                <div>
                    <h3 class="font-semibold text-lg"><%= item.name %></h3>
                    <p class="text-sm text-gray-400">₹<%= item.price %></p>
                    <% if (item.description) { %><p class="text-xs text-gray-500"><%= item.description %></p><% } %>
                </div>
                <button class="addItemBtn btn-primary text-white px-3 py-1 rounded">Add</button>
            </div>
            <% }) %>
        </div>

        <div id="cartModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
            <div class="card p-6 max-w-md w-full">
                <h2 class="text-xl font-bold mb-4">Your Order</h2>
                <div id="cartItems" class="space-y-2 mb-4"></div>
                <div class="flex justify-between items-center mb-4">
                    <span class="font-semibold">Total</span>
                    <span id="cartTotal" class="font-bold">₹0</span>
                </div>
                <div class="flex gap-3">
                    <button id="placeOrderBtn" class="flex-1 btn-primary text-white py-2 rounded">Place Order</button>
                    <button id="closeCartBtn" class="flex-1 bg-gray-600 text-white py-2 rounded">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const tableNum = <%= tableNum %>;
        let cart = [];

        function renderCartCount() {
            document.getElementById('cartCount').textContent = cart.reduce((s, i) => s + i.qty, 0);
        }

        function openCart() {
            const container = document.getElementById('cartItems');
            const totalEl = document.getElementById('cartTotal');
            container.innerHTML = '';
            let total = 0;
            cart.forEach(it => {
                total += it.price * it.qty;
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center';
                div.innerHTML = `<span>${it.name} x${it.qty}</span><span>₹${it.price * it.qty}</span>`;
                container.appendChild(div);
            });
            totalEl.textContent = `₹${total}`;
            document.getElementById('cartModal').classList.remove('hidden');
        }

        document.getElementById('cartBtn').addEventListener('click', openCart);
        document.getElementById('closeCartBtn').addEventListener('click', () => {
            document.getElementById('cartModal').classList.add('hidden');
        });

        document.querySelectorAll('.addItemBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                const card = btn.closest('[data-id]');
                const id = card.dataset.id;
                const name = card.querySelector('h3').textContent;
                const price = Number(card.querySelector('p').textContent.replace('₹', ''));
                const existing = cart.find(i => i.id === id);
                if (existing) existing.qty++;
                else cart.push({ id, name, price, qty: 1 });
                renderCartCount();
            });
        });

        document.getElementById('placeOrderBtn').addEventListener('click', async () => {
            if (!cart.length) return alert('Cart is empty');
            const res = await fetch('/api/table-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tableNum, items: cart })
            });
            if (res.ok) {
                alert('Order placed successfully!');
                cart = [];
                renderCartCount();
                document.getElementById('cartModal').classList.add('hidden');
            } else {
                alert('Failed to place order');
            }
        });
    </script>
</body>
</html>